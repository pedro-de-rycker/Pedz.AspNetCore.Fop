# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    tags: ['[0-9]+.[0-9]+.[0-9]+']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        default: '1.0.0'

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

permissions:
  id-token: write
  contents: read

jobs:
  build:
    uses: ./.github/workflows/minimal-api__build.yml

  deploy:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    environment: release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        dotnet-quality: 'signed'
    - name: Build project for Minimal Api
      run: dotnet build --configuration Release -p:Version=${{github.ref_name}}
    - name: Pack nuget
      run: dotnet pack ${{ github.workspace }}/sources/Pedz.AspNetCore.Fop.MinimalApi/Pedz.AspNetCore.Fop.MinimalApi.csproj --configuration Release -p:Version=${{github.ref_name}} --no-build --output ${{ github.workspace }}/releases
    - name: NuGet login (OIDC â†’ temp API key)
      uses: NuGet/login@v1
      id: login
      with:
        user: ${{ secrets.NUGET_USER }}
    - name: Push nuget
      run: dotnet nuget push ${{ github.workspace }}/releases/Pedz.AspNetCore.Fop.MinimalApi.${{github.ref_name}}.nupkg --source https://www.nuget.org/api/v2/package --api-key ${{steps.login.outputs.NUGET_API_KEY}}
    - name: Add release assets
      run: gh release upload "${{ github.ref_name }}" ${{ github.workspace }}/releases/Pedz.AspNetCore.Fop.MinimalApi.${{github.ref_name}}.nupkg
      env:
        GH_TOKEN: ${{ github.token }}